<template>
  <div id="entry-page" class="loading-container">
    <div class="col-sm-10 offset-sm-1 col-md-10 offset-md-1 col-lg-8 offset-lg-2">
      <div class="alert alert-primary">
        <h3>重要なお知らせ</h3>
        本ゲームは、以下のブラウザでは<strong>正常に操作できない場合がございます</strong>。なるべくご利用くださらないよう、お願い申し上げます。<br>
        Internet Explorer / Microsoft Edge / Android標準ブラウザ（Chromeではないほう）
      </div>
      <div class="alert alert-warning">
        <h3>初心者向けの注意点</h3>
        本ゲームは、一般的なスマホゲームなどと、以下の点において異なります。あらかじめご留意ください。
        <ul>
          <li>5日以上ログインしていないとアカウントが削除されるようになっています。毎日3〜5分程度（慣れれば1分程度）のプレイが推奨されます。</li>
          <li>どこかの国が統一するとすべてのゲームデータが初期化され、また最初から登録し直しになります。</li>
          <li>国家間の戦力差を抑える、均衡にする、弱そうな国に仕官するのは、プレイヤーのみなさんがこのゲームを楽しく長く遊べるようにするために意識している不文律です。三国志NETはプレイヤーのみなさんの良心によって構成されるオンラインゲームであり、<strong>単に統一することは、このゲームにおける勝利を意味しません。ゲームを楽しんだ人の勝ちです。</strong>強そうな国にとびつかず、みなさんが楽しめる思い出作りをしていきましょう。<br>
          <li>武将能力は、はじめはあまり深く考えなくても大丈夫です。能力について詳しく知りたければ、とにかく登録しましょう。</li>
        </ul>
      </div>
      <div class="section">
        <h3>基本情報</h3>
        <div v-if="system.invitationCodeRequestedAtEntry" :class="{ 'form-row': true, 'error': !isOkInvitationCode, }">
          <div class="label">招待コード</div>
          <div class="field">
            <input type="text" v-model="invitationCode">
          </div>
          <div class="detail">
            別途連絡した招待コードを入力してください
          </div>
        </div>
        <div :class="{ 'form-row': true, 'error': !isOkName, }">
          <div class="label">名前</div>
          <div class="field">
            <input type="text" v-model="character.name">
          </div>
          <div class="detail">
            1 - 12 文字になるようにしてください。他の人と同じ名前にはできません。_（アンダーバー）は使用できません
          </div>
        </div>
        <div :class="{ 'form-row': true, 'error': !isOkAliasId, }">
          <div class="label">ログイン用ID</div>
          <div class="field">
            <input type="text" v-model="character.aliasId">
          </div>
          <div class="detail">
            4 - 12 文字になるようにしてください。他の人と同じIDにはできません
          </div>
        </div>
        <div :class="{ 'form-row': true, 'error': !isOkPassword, }">
          <div class="label">パスワード</div>
          <div class="field">
            <input type="password" v-model="password">
          </div>
          <div class="detail">
            4 - 12 文字になるようにしてください
          </div>
        </div>
        <div :class="{ 'form-row': true, 'error': !isOkPasswordConfirm, }">
          <div class="label">パスワード確認</div>
          <div class="field">
            <input type="password" v-model="passwordConfirm">
          </div>
          <div class="detail">
            パスワードを再度入力してください
          </div>
        </div>
        <div :class="{ 'form-row': true, 'error': !isOkIcon, }">
          <div class="label">アイコン</div>
          <div class="field">
            <CharacterIconPicker v-model="icon"/>
          </div>
          <div class="detail">
            アイコンを設定します。Gravatarは、外部サービスのアイコンを利用するものです。登録した後に自分で用意した画像をアップロードすることができます（PNG、JPEG、GIF）
          </div>
        </div>
      </div>
      <div class="section">
        <h3>能力</h3>
        <div style="margin:8px 0">
          自分に向いた能力を高めに設定しましょう。戦争参加する場合、統率は最低でも50は確保します
        </div>
        <div :class="{ 'form-row': true, 'error': !isOkStrong, }">
          <div class="label">武力（戦争参加／時間のある方／深夜遊べる方向け）</div>
          <div class="field">
            <input type="number" :max="extraData.attributeMax" min="5" v-model="character.strong">
          </div>
          <div class="detail">
            5 - {{ extraData.attributeMax }} の範囲で設定してください
          </div>
        </div>
        <div :class="{ 'form-row': true, 'error': !isOkIntellect, }">
          <div class="label">知力（内政／弱めの兵種で戦争参加可／初心者だけど活躍したい人向け）</div>
          <div class="field">
            <input type="number" :max="extraData.attributeMax" min="5" v-model="character.intellect">
          </div>
          <div class="detail">
            5 - {{ extraData.attributeMax }} の範囲で設定してください
          </div>
        </div>
        <div :class="{ 'form-row': true, 'error': !isOkLeadership, }">
          <div class="label">統率（徴兵可能な兵士数。戦争参加に必要）</div>
          <div class="field">
            <input type="number" :max="extraData.attributeMax" min="5" v-model="character.leadership">
          </div>
          <div class="detail">
            5 - {{ extraData.attributeMax }} の範囲で設定してください
          </div>
        </div>
        <div :class="{ 'form-row': true, 'error': !isOkPopularity, }">
          <div class="label">人望（時間ほとんどない方／初心者で雰囲気だけでも知りたい方向け）</div>
          <div class="field">
            <input type="number" :max="extraData.attributeMax" min="5" v-model="character.popularity">
          </div>
          <div class="detail">
            5 - {{ extraData.attributeMax }} の範囲で設定してください
          </div>
        </div>
        <div :class="{ 'form-row': true, 'error': !isOkSumOfAttributes, }">
          <div class="label">合計</div>
          <div class="field">
            <span style="padding-right:12px;font-size:32px;font-weight:bold">{{ sumOfAttributes }}</span>
            ( {{ character.strong }} + {{ character.intellect }} + {{ character.leadership }} + {{ character.popularity }} )
          </div>
          <div class="detail">
            能力合計が <span class="number">{{ extraData.attributeSumMax }}</span> になるようにしてください
          </div>
        </div>
      </div>
      <div class="section">
        <h3>所属</h3>
        <div :class="{ 'form-row': true, 'error': !isOkTown, }">
          <div class="label">初期都市</div>
          <div class="field" style="height:500px">
            <Map
              :towns="towns"
              :countries="countries"
              :town="town"
              :currentTown="town"
              @selected="onTownChanged($event)"/>
          </div>
          <div class="country-list">
            <div :class="'country-list-item row country-color-' + country.colorId + (!town.id || town.countryId === country.id ? ' selected' : '')"
                 v-for="country in countries"
                 :key="country.id"
                 v-show="!country.hasOverthrown">
              <div :class="'col-md-3 country-name country-color-' + country.colorId">{{ country.name }}<br><span v-if="getExtraData(country.id).isJoinLimited" class="is-limited">人数制限のため入国不可</span></div>
              <div :class="'col-md-9 country-message country-color-' + country.colorId">
                <div class="icon"><CharacterIcon :icon="getCountryMessage(country).writerIcon"/></div>
                <div class="message">
                  <div class="text"><KmyChatTagText :text="getCountryMessage(country).message"/></div>
                  <div class="writer" v-if="getCountryMessage(country).message">{{ getCountryMessage(country).writerCharacterName }} ({{ getCountryPostName(getCountryMessage(country).writerPost) }}) より</div>
                </div>
              </div>
            </div>
          </div>
          <div class="detail">
            地図上の都市をクリックして選択してください。選択した都市に国があれば、そこへ仕官します。なお、48年1月までは、人数の多い国に仕官することはできません
          </div>
        </div>
      </div>
      <div class="section">
        <h3>建国</h3>
        <div :class="{ 'form-row': true, 'error': !isOkEstablishSelection, }">
          <div class="label">建国の可否</div>
          <div class="field">
            <button type="button" :class="{ 'btn': true, 'btn-toggle': true, 'selected': isPublish, }" @click="isPublish ^= true">建国する</button>
          </div>
          <div class="detail">
            建国する場合は、上のボタンをONにしてください
          </div>
        </div>
        <div v-show="isPublish" :class="{ 'form-row': true, 'error': !isOkTown, 'warning': town.type === 3 }">
          <div class="label">選択都市の都市特化</div>
          <div class="field">
            <span v-show="town.type === 1">農業都市</span>
            <span v-show="town.type === 2">商業都市</span>
            <span v-show="town.type === 3">城塞都市</span>
            <span v-show="town.type === 4">大都市</span>
          </div>
          <div class="detail">
            <span v-show="town.type === 3">城塞都市は、<u>農業・商業最大がゼロになることがある</u>ため、<strong>初心者にはおすすめできません</strong></span>
          </div>
        </div>
        <div v-show="isPublish" :class="{ 'form-row': true, 'error': !isOkTown }">
          <div class="label">選択都市の都市施設</div>
          <div class="field">
            {{ townBuilding.name }}
          </div>
          <div class="detail">
          </div>
        </div>
        <div v-show="isPublish" :class="{ 'form-row': true, 'error': !isOkCountryName, }">
          <div class="label">国名</div>
          <div class="field">
            <input type="text" v-model="country.name">
          </div>
          <div class="detail">
            1 - 8 文字になるようにしてください。他の国と同じ名前にはできません
          </div>
        </div>
        <div v-show="isPublish" :class="{ 'form-row': true, 'error': !isOkCountryColor, }">
          <div class="label">国色</div>
          <div class="field">
            <CountryColorPicker v-model="country.colorId" :countries="countries"/>
          </div>
          <div class="detail">
            国の色を決めてください。他の国と同じ色にはできません
          </div>
        </div>
      </div>

<!-- https://developers.google.com/recaptcha/docs/invisible#js_api
     https://syncer.jp/how-to-introduction-recaptcha -->
      <div id='recaptcha' class="g-recaptcha"
          data-sitekey="your_site_key"
          data-callback=""
          data-size="invisible"></div>
      <button v-show="false" type="button" id="callback" @click="$emit('entry-abort')"></button>
      <button v-show="false" type="button" class="btn btn-primary" onclick="grecaptcha.execute()">送信</button>
      <button v-show="canEntry" type="button" class="btn btn-primary" @click="entry()">送信</button>
      <span v-show="!canEntry" style="color:red">上の記述項目の赤いところをすべて入力するか、修正してください</span>
    </div>
    <div v-show="isLoading" class="loading"><div class="loading-icon"></div></div>
  </div>
</template>

<script lang="ts">
import { Component, Vue, Prop } from 'vue-property-decorator';
import Map from '@/components/parts/Map.vue';
import CharacterIcon from '@/components/parts/CharacterIcon.vue';
import CharacterIconPicker from '@/components/parts/CharacterIconPicker.vue';
import CountryColorPicker from '@/components/parts/CountryColorPicker.vue';
import AsyncUtil from '../../models/common/AsyncUtil';
import ArrayUtil from '../../models/common/arrayutil';
import Streaming from './../../api/streaming';
import ApiStreaming from './../../api/apistreaming';
import * as api from './../../api/api';
import * as def from '@/common/definitions';
import Enumerable from 'linq';
import NotificationService from '@/services/notificationservice';
import LoginService from '@/models/character/loginservice';
import ValueUtil from '@/models/common/ValueUtil';
import KmyChatTagText from '@/components/parts/KmyChatTagText.vue';

declare const grecaptcha: any;

@Component({
  components: {
    Map,
    CharacterIcon,
    CharacterIconPicker,
    CountryColorPicker,
    KmyChatTagText,
  },
})
export default class EntryPage extends Vue {
  private character: api.Character = new api.Character();
  private country: api.Country = new api.Country();
  private defaultCountry: api.Country = new api.Country();
  private town: api.Town = new api.Town();
  private password: string = '';
  private passwordConfirm: string = '';
  private icon: api.CharacterIcon = new api.CharacterIcon(0, 0, true, 1, '0.gif');
  private isPublish: boolean = false;
  private invitationCode: string = '';

  @Prop() private system!: api.SystemData;
  @Prop() private countries!: api.Country[];
  @Prop() private countryMessages!: api.CountryMessage[];
  private extraData: api.EntryExtraData = api.EntryExtraData.default;
  @Prop() private towns!: api.Town[];
  private nextMonthSeconds = 0;

  private isLoadingExtraData = true;
  private isEntrying = false;

  private get sumOfAttributes(): number {
    return parseInt(this.character.strong.toString(), 10) +
      parseInt(this.character.intellect.toString(), 10) +
      parseInt(this.character.leadership.toString(), 10) +
      parseInt(this.character.popularity.toString(), 10);
  }

  private get isLoading(): boolean {
    return this.isLoadingExtraData || this.isEntrying;
  }

  private get isOkName(): boolean {
    return this.character.name !== '' && this.character.name.length >= 1 && this.character.name.length <= 12
      && !this.character.name.includes('_');
  }

  private get isOkAliasId(): boolean {
    return this.character.aliasId !== '' && this.character.aliasId.length >= 4 && this.character.aliasId.length <= 12;
  }

  private get isOkPassword(): boolean {
    return this.password !== '' && this.password.length >= 4 && this.password.length <= 12;
  }

  private get isOkPasswordConfirm(): boolean {
    return this.password === this.passwordConfirm && this.isOkPassword;
  }

  private get isOkIcon(): boolean {
    return true;
  }

  private get isOkTown(): boolean {
    if (this.town.id !== 0) {
      const extraData = this.getExtraData(this.town.countryId);
      return !extraData.isJoinLimited;
    } else {
      return false;
    }
  }

  private get isOkEstablishSelection(): boolean {
    return (this.town.countryId !== 0 && !this.isPublish) ||
      (this.town.countryId === 0 && this.isPublish);
  }

  private get isOkCountryName(): boolean {
    return !this.isPublish ||
      (this.country.name !== '' && this.country.name.length >= 1 && this.country.name.length <= 8 &&
       !Enumerable.from(this.countries).any((c) => c.name === this.country.name));
  }

  private get isOkCountryColor(): boolean {
    return !this.isPublish ||
      (this.country.colorId >= 1 && this.country.colorId <= def.COUNTRY_COLOR_NUM &&
       !Enumerable.from(this.countries).any((c) => c.colorId === this.country.colorId));
  }

  private get isOkStrong(): boolean {
    return this.character.strong >= 5 && this.character.strong <= this.extraData.attributeMax;
  }

  private get isOkIntellect(): boolean {
    return this.character.intellect >= 5 && this.character.intellect <= this.extraData.attributeMax;
  }

  private get isOkLeadership(): boolean {
    return this.character.leadership >= 5 && this.character.leadership <= this.extraData.attributeMax;
  }

  private get isOkPopularity(): boolean {
    return this.character.popularity >= 5 && this.character.popularity <= this.extraData.attributeMax;
  }

  private get isOkSumOfAttributes(): boolean {
    return this.sumOfAttributes === this.extraData.attributeSumMax;
  }

  private get isOkInvitationCode(): boolean {
    return !this.system.invitationCodeRequestedAtEntry ||
      this.invitationCode.length > 0;
  }

  private get canEntry(): boolean {
    return this.isOkName &&
      this.isOkAliasId &&
      this.isOkPassword &&
      this.isOkPasswordConfirm &&
      this.isOkIcon &&
      this.isOkTown &&
      this.isOkEstablishSelection &&
      this.isOkCountryName &&
      this.isOkCountryColor &&
      this.isOkStrong &&
      this.isOkIntellect &&
      this.isOkLeadership &&
      this.isOkPopularity &&
      this.isOkSumOfAttributes &&
      this.isOkInvitationCode
      ;
  }

  public get townBuilding(): def.BuildingType {
    const result = Enumerable
      .from(def.TOWN_BUILDINGS)
      .firstOrDefault((b) => this.town.townBuilding === b.id);
    if (result) {
      return result;
    } else {
      return def.BuildingType.default;
    }
  }

  private initializeRecaptcha() {
    // https://stackoverflow.com/questions/43890035/vue-js-google-recaptcha-callback
    setTimeout(() => {
      if (typeof grecaptcha === 'undefined') {
        this.initializeRecaptcha();
      } else {
        grecaptcha.render('recaptcha', {
          sitekey: 'SITE_KEY',
          size: 'invisible',
          badge: 'inline',
          // callback: self.submit,
        });
      }
    }, 100);
  }

  private getExtraData(countryId: number): api.CountryExtraData {
    const data = ArrayUtil.findUniquely(this.extraData.countryData, countryId, (ed) => ed.countryId);
    if (data) {
      return data;
    } else {
      return api.CountryExtraData.default;
    }
  }

  private getCountryMessage(country: api.Country): api.CountryMessage {
    const data = ArrayUtil.findUniquely(this.countryMessages, country.id, (cm) => cm.countryId);
    if (data) {
      return data;
    } else {
      return new api.CountryMessage();
    }
  }

  private getCountryPostName(post: number): string {
    return ValueUtil.getPostName(post);
  }

  private created() {
    this.character.strong = 5;
    this.character.intellect = 5;
    this.character.leadership = 5;
    this.character.popularity = 5;

    // ストリーミングを開始
    ApiStreaming.top.on<api.SystemData>(api.SystemData.typeId, (log) => {
      this.updateExtraData();
    });
    ApiStreaming.top.on<api.MapLog>(api.MapLog.typeId, (log) => {
      if (log.eventType === 12 ||
          log.eventType === 15 ||
          log.eventType === 16 ||
          log.eventType === 17 ||
          log.eventType === 18 ||
          log.eventType === 19 ||
          log.eventType === 20 ||
          log.eventType === 21 ||
          log.eventType === 22) {
        this.updateExtraData();
      }
    });

    this.updateExtraData();
  }

  private updateExtraData() {
    const requested = Enumerable.from(this.countries)
      .any((c) => api.GameDateTime.toNumber(c.established) + def.BATTLE_STOP_TURN >
          api.GameDateTime.toNumber(this.system.gameDateTime));
    if (requested || this.isLoadingExtraData) {
      this.isLoadingExtraData = true;
      api.Api.getEntryExtraData()
        .then((data) => {
          this.extraData = data;
        })
        .catch(() => {
          NotificationService.entryExtraDataFailed.notify();
        })
        .finally(() => {
          this.isLoadingExtraData = false;
        });
    }
  }

  private onTownChanged(id: number) {
    const t = ArrayUtil.find(this.towns, id);
    if (t) {
      this.town = t;
      this.character.townId = t.id;
    }
  }

  private entry() {
    if (this.canEntry || true) {
      this.isEntrying = true;
      api.Api.entry(this.character,
                    this.icon,
                    this.password,
                    this.isPublish ? this.country : this.defaultCountry,
                    this.invitationCode)
        .then((auth) => {
          LoginService.setAccessToken(auth);
          this.$router.push('status');
        })
        .catch((ex) => {
          if (ex.data.code === api.ErrorCode.duplicateCharacterNameOrAliasIdError) {
            NotificationService.entryFailedBecauseSameNameOrAliasId.notify();
          } else if (ex.data.code === api.ErrorCode.duplicateCountryNameOrColorError) {
            NotificationService.entryFailedBecauseSameCountryNameOrColor.notify();
          } else if (ex.data.code === api.ErrorCode.duplicateEntryError) {
            NotificationService.entryFailedBecauseSameIpAddress.notify();
          } else if (ex.data.code === api.ErrorCode.invitationCodeRequestedError) {
            NotificationService.entryFailedBecauseInvitationCode.notify();
          } else if (ex.data.code === api.ErrorCode.invalidSecretKeyError) {
            NotificationService.entryFailedBecauseInvalidSecretKey.notify();
          } else {
            NotificationService.entryFailed.notify();
          }
        })
        .finally(() => {
          this.isEntrying = false;
        });
    }
  }
}
</script>

<style lang="scss" scoped>
@import '@/scss/country-color.scss';
span.number { font-weight: bold; }

#entry-page {
  margin-top: 24px;
}

.section {
  margin: 24px 0;

  .form-row {
    display: block;
    background-color: #def;
    border-right: 4px solid blue;
    padding: 12px 8px;

    &.error {
      background-color: #fde;
      border-right-color: red;
      .detail {
        color: red;
      }
    }

    &.warning {
      background-color: #ffe;
      border-right-color: #ff0;
      .detail {
        color: #992;
      }
    }

    .label {
      color: #999;
      font-weight: bold;
    }

    .field {
      margin-left: 12px;
    }

    .detail {
      font-size: 14px;
      margin-left: 16px;
      margin-top: 4px;
      color: #666;
    }

    input {
      width: 100%;
    }

    .country-list {
      margin: 8px 16px;
      overflow: hidden;
      border-radius: 16px;
      .country-list-item {
        @include country-color-light('background-color');
        @include country-color-deep('color');
        @include country-color-deep('border-bottom-color');
        padding: 8px;
        opacity: 0.5;
        border-bottom-width: 3px;
        border-bottom-style: double;
        &:last-child {
          border-bottom-width: 0;
        }
        &.selected {
          opacity: 1;
        }
        .country-name {
          align-self: center;
          .is-limited {
            color: red;
            font-weight: bold;
          }
        }
        .country-message {
          display: flex;
          align-items: center;
          .icon {
            margin-right: 12px;
            img {
              width: 48px;
              height: 48px;
            }
          }
          .message {
            flex: 1;
          }
          .writer {
            text-align: right;
            font-weight: bold;
            font-size: 0.8em;
          }
        }
      }
    }
  }
}
</style>
